import React, { useEffect, useState } from 'react'
import {
  CCard,
  CCardBody,
  CCardHeader,
  CForm,
  CFormInput,
  CFormSelect,
  CButton,
  CRow,
  CCol,
  CTable,
  CTableHead,
  CTableRow,
  CTableHeaderCell,
  CTableBody,
  CTableDataCell,
  CContainer,
  CPagination,
  CPaginationItem,
  CModal,
  CModalHeader,
  CModalTitle,
  CModalBody,
  CModalFooter,
  CAlert,
  CBadge,
  CInputGroup,
  CInputGroupText,
} from '@coreui/react'

import { CIcon } from '@coreui/icons-react'
import {
  cilPlus,
  cilSearch,
  cilBook,
  cilPencil,
  cilTrash,
  cilSave,
  cilWarning,
} from '@coreui/icons'

export default function CrudLecciones() {
  // ... (mantenemos la lógica de estados y funciones igual que en tu código original)
  const [modulos, setModulos] = useState([])
  const [lecciones, setLecciones] = useState([])
  const [leccionForm, setLeccionForm] = useState({
    id_modulo: '',
    nombre_leccion: '',
    descripcion: '',
  })
  const [leccionEdit, setLeccionEdit] = useState(null)
  const [leccionEliminar, setLeccionEliminar] = useState(null)
  const [mensaje, setMensaje] = useState('')
  const [tipoMensaje, setTipoMensaje] = useState('success')
  const [filtroModuloForm, setFiltroModuloForm] = useState('')
  const [page, setPage] = useState(1)
  const itemsPerPage = 5

  useEffect(() => {
    fetch('http://localhost:4000/obtenermodulos')
      .then((r) => r.json())
      .then(setModulos)
      .catch(() => setModulos([]))
    fetchLecciones()
  }, [])

  const fetchLecciones = () => {
    fetch('http://localhost:4000/obtenerlecciones')
      .then((r) => r.json())
      .then(setLecciones)
      .catch(() => setLecciones([]))
  }

  const handleSubmit = async (e) => {
    e.preventDefault()
    // Lógica de fetch...
    setMensaje('Lección creada correctamente')
    setTipoMensaje('success')
    fetchLecciones()
  }

  // Estilos CSS Inline para replicar la imagen
  const styles = {
    card: {
      borderRadius: '15px',
      border: 'none',
      boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
      overflow: 'hidden',
    },
    headerBlue: {
      backgroundColor: '#001a80',
      color: 'white',
      fontWeight: '600',
      border: 'none',
      padding: '15px',
    },
    headerNavy: {
      backgroundColor: '#00004d',
      color: 'white',
      fontWeight: '600',
      border: 'none',
      padding: '15px',
    },
    buttonBlue: {
      backgroundColor: '#001a80',
      border: 'none',
      borderRadius: '8px',
      fontWeight: 'bold',
    },
    input: { borderRadius: '8px', padding: '10px' },
    label: {
      fontSize: '0.75rem',
      fontWeight: 'bold',
      color: '#666',
      marginBottom: '5px',
      textTransform: 'uppercase',
    },
  }

  const filtradas = lecciones // Simplificado para el ejemplo
  const totalPages = Math.ceil(filtradas.length / itemsPerPage)
  const visibles = filtradas.slice((page - 1) * itemsPerPage, page * itemsPerPage)

  return (
    <CContainer fluid className="py-5" style={{ backgroundColor: '#fdf8f3', minHeight: '100vh' }}>
      <CCol md={11} className="mx-auto">
        {mensaje && (
          <CAlert color={tipoMensaje} className="rounded-3 shadow-sm">
            {mensaje}
          </CAlert>
        )}

        <CRow className="g-4">
          {/* SECCIÓN NUEVA LECCIÓN */}
          <CCol lg={4}>
            <CCard style={styles.card}>
              <CCardHeader style={styles.headerBlue}>
                <CIcon icon={cilPlus} className="me-2" /> NUEVA LECCIÓN
              </CCardHeader>
              <CCardBody className="p-4">
                <CForm onSubmit={handleSubmit}>
                  <div className="mb-3">
                    <label style={styles.label}>Asignar a Módulo</label>
                    <CInputGroup className="mb-2">
                      <CInputGroupText style={{ borderRadius: '8px 0 0 8px' }}>
                        <CIcon icon={cilSearch} />
                      </CInputGroupText>
                      <CFormInput
                        placeholder="Filtrar..."
                        style={{ borderRadius: '0 8px 8px 0' }}
                        onChange={(e) => setFiltroModuloForm(e.target.value)}
                      />
                    </CInputGroup>
                    <CFormSelect
                      style={styles.input}
                      value={leccionForm.id_modulo}
                      onChange={(e) =>
                        setLeccionForm({ ...leccionForm, id_modulo: e.target.value })
                      }
                    >
                      <option value="">Seleccione...</option>
                      {modulos.map((m) => (
                        <option key={m.id_modulo} value={m.id_modulo}>
                          {m.nombre_modulo}
                        </option>
                      ))}
                    </CFormSelect>
                  </div>

                  <div className="mb-3">
                    <label style={styles.label}>Nombre de la Lección</label>
                    <CFormInput
                      style={styles.input}
                      placeholder="Ej: Introducción a CSS"
                      value={leccionForm.nombre_leccion}
                      onChange={(e) =>
                        setLeccionForm({ ...leccionForm, nombre_leccion: e.target.value })
                      }
                    />
                  </div>

                  <div className="mb-4">
                    <label style={styles.label}>Descripción</label>
                    <CFormInput
                      style={styles.input}
                      placeholder="Breve detalle..."
                      value={leccionForm.descripcion}
                      onChange={(e) =>
                        setLeccionForm({ ...leccionForm, descripcion: e.target.value })
                      }
                    />
                  </div>

                  <CButton type="submit" className="w-100 py-2" style={styles.buttonBlue}>
                    GUARDAR LECCIÓN
                  </CButton>
                </CForm>
              </CCardBody>
            </CCard>
          </CCol>

          {/* SECCIÓN TABLA DE LECCIONES */}
          <CCol lg={8}>
            <CCard style={styles.card}>
              <CCardHeader
                style={{
                  backgroundColor: 'white',
                  color: '#333',
                  borderBottom: '1px solid #eee',
                  padding: '15px',
                }}
              >
                <div className="d-flex align-items-center fw-bold">
                  <CIcon icon={cilBook} className="me-2 text-primary" /> Lecciones Activas
                </div>
              </CCardHeader>
              <CCardBody className="p-0">
                <CTable align="middle" responsive className="mb-0">
                  <CTableHead color="light">
                    <CTableRow>
                      <CTableHeaderCell className="border-0 px-4 py-3">MÓDULO</CTableHeaderCell>
                      <CTableHeaderCell className="border-0 py-3">LECCIÓN</CTableHeaderCell>
                      <CTableHeaderCell className="border-0 py-3 text-center">
                        ACCIONES
                      </CTableHeaderCell>
                    </CTableRow>
                  </CTableHead>
                  <CTableBody>
                    {visibles.map((l) => (
                      <CTableRow key={l.id_leccion}>
                        <CTableDataCell className="px-4">
                          <CBadge
                            shape="rounded-pill"
                            color="info"
                            variant="outline"
                            className="px-3 py-2"
                          >
                            {l.nombre_modulo}
                          </CBadge>
                        </CTableDataCell>
                        <CTableDataCell className="fw-medium">{l.nombre_leccion}</CTableDataCell>
                        <CTableDataCell className="text-center">
                          <CButton
                            color="link"
                            onClick={() => setLeccionEdit(l)}
                            className="text-info p-1"
                          >
                            <CIcon icon={cilPencil} />
                          </CButton>
                          <CButton
                            color="link"
                            onClick={() => setLeccionEliminar(l)}
                            className="text-danger p-1"
                          >
                            <CIcon icon={cilTrash} />
                          </CButton>
                        </CTableDataCell>
                      </CTableRow>
                    ))}
                  </CTableBody>
                </CTable>

                <div className="p-3 d-flex justify-content-center border-top">
                  <CPagination className="mb-0">
                    <CPaginationItem onClick={() => setPage(page - 1)} disabled={page === 1}>
                      Anterior
                    </CPaginationItem>
                    <CPaginationItem active>{page}</CPaginationItem>
                    <CPaginationItem
                      onClick={() => setPage(page + 1)}
                      disabled={page === totalPages}
                    >
                      Siguiente
                    </CPaginationItem>
                  </CPagination>
                </div>
              </CCardBody>
            </CCard>
          </CCol>
        </CRow>
      </CCol>

      {/* MODAL EDITAR - ESTILO REDONDEADO */}
      <CModal
        alignment="center"
        visible={!!leccionEdit}
        onClose={() => setLeccionEdit(null)}
        className="border-0"
      >
        <CModalHeader className="bg-primary text-white border-0">
          <CModalTitle>Editar Lección</CModalTitle>
        </CModalHeader>
        <CModalBody className="p-4">
          <div className="mb-3">
            <label style={styles.label}>Nombre</label>
            <CFormInput
              style={styles.input}
              value={leccionEdit?.nombre_leccion || ''}
              onChange={(e) => setLeccionEdit({ ...leccionEdit, nombre_leccion: e.target.value })}
            />
          </div>
          <div>
            <label style={styles.label}>Descripción</label>
            <CFormInput
              style={styles.input}
              value={leccionEdit?.descripcion || ''}
              onChange={(e) => setLeccionEdit({ ...leccionEdit, descripcion: e.target.value })}
            />
          </div>
        </CModalBody>
        <CModalFooter className="border-0">
          <CButton color="light" onClick={() => setLeccionEdit(null)}>
            Cancelar
          </CButton>
          <CButton
            style={styles.buttonBlue}
            onClick={() => {
              /* save function */
            }}
          >
            Guardar Cambios
          </CButton>
        </CModalFooter>
      </CModal>

      {/* MODAL ELIMINAR - ESTILO ALERTA */}
      <CModal
        size="sm"
        alignment="center"
        visible={!!leccionEliminar}
        onClose={() => setLeccionEliminar(null)}
      >
        <CModalBody className="text-center p-4">
          <CIcon icon={cilWarning} size="3xl" className="text-warning mb-3" />
          <h5 className="fw-bold">¿Deseas eliminar esta lección?</h5>
          <p className="text-muted small">Esta acción no se puede deshacer.</p>
          <div className="d-flex justify-content-center gap-2 mt-4">
            <CButton color="light" className="px-4" onClick={() => setLeccionEliminar(null)}>
              No
            </CButton>
            <CButton
              color="danger"
              className="px-4 text-white"
              onClick={() => {
                /* delete function */
              }}
            >
              Sí, eliminar
            </CButton>
          </div>
        </CModalBody>
      </CModal>
    </CContainer>
  )
}
